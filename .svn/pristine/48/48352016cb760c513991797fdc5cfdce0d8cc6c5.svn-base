<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title></title>
    <link rel="stylesheet" href="/Resources/css/voucher.css"/>
</head>
<body>
    <div class="wrapper-md" id="root" onpaste="return false">
        <div class="w1020" style="position:relative;">
            <div class="mainContainer voucherContainer" style="padding:0 35px;">
                <div class="layui-row">
                    <div class="layui-col-xs1">
                        <remote-sel v-bind:setting="VoucherSetting" v-bind:value.sync="ShowVoucher.Type" @change="TypeChange"></remote-sel>
                    </div>
                    <div class="layui-col-xs3">
                        <div class="voucherNoContainer">
                            字
                            <input type="text" name="name" value=" " v-model="VoucherDetailInfo.No" disabled/>
                        </div>
                    </div>
                    <div class="layui-col-xs1">制单日期</div>
                    <div class="layui-col-xs3">
                        <div class="datepicker">
                            <lay-date v-bind:value.sync="VoucherDetailInfo.Time |formatTime '2017-11-29 h:mm:ss'" type='datetime' initial="off"></lay-date>
                        </div>
                    </div>
                    <div class="layui-col-xs1">审核日期</div>
                    <div class="layui-col-xs3">
                        <div class="datepicker">
                            <lay-date v-bind:value.sync="(VoucherDetailInfo.ValidTime)?'VoucherDetailInfo.ValidTime |formatTime '2017-11-29 h:mm:ss')':''" type='datetime' initial="off" disabled></lay-date>
                        </div>
                    </div>
                </div>
            </div>
            <div class="voucher">
                <table class="table voucherMaking" style="background-color:#fff;width: 1000px">
                    <thead>
                        <tr>
                            <th></th>
                            <th>摘要</th>
                            <th>会计科目</th>
                            <th class="listNumberHide">数量</th>
                            <th>
                                <p>借方金额</p>
                                <ul class="moneyList">
                                    <li>亿</li>
                                    <li>千</li>
                                    <li>百</li>
                                    <li class="lineBlue">十</li>
                                    <li>万</li>
                                    <li>千</li>
                                    <li class="lineBlue">百</li>
                                    <li>十</li>
                                    <li>元</li>
                                    <li class="lineRed">角</li>
                                    <li>分</li>
                                </ul>
                            </th>
                            <th>
                                <p>贷方金额</p>
                                <ul class="moneyList">
                                    <li>亿</li>
                                    <li>千</li>
                                    <li>百</li>
                                    <li class="lineBlue">十</li>
                                    <li>万</li>
                                    <li>千</li>
                                    <li class="lineBlue">百</li>
                                    <li>十</li>
                                    <li>元</li>
                                    <li class="lineRed">角</li>
                                    <li>分</li>
                                </ul>
                            </th>
                            <th></th>
                        </tr>
                    </thead>
                </table>
                <div class="tbodyList">
                    <table class="table voucherMaking" id="voucherMaking" style="width: 1000px;">
                        <tbody>
                            <tr v-for="item in VoucherDetailInfo.VoucherDetails" id="98470441ADD">
                                <th>
                                    <span class="addDataLine" tabindex="-1" role="button" @click="addDataLine($event,$index)">+</span>
                                </th>
                                <th style="overflow: hidden">
                                    <!--摘要-->
                                    <div class="displayDiv" id="voucher{{item.VoucherDetailsID}}">{{item.Title}}</div>
                                    <textarea type="text" id="voucher{{item.VoucherDetailsID}}" v-model="item.Title" class="displayInput" @focus="ShowOneVoucher(item)"></textarea>
                                </th>
                                <th>
                                    <!--科目-->
                                    <div class="subjectDiv">
                                        <div class="displayDiv" id="subject{{item.VoucherDetailsID}}">{{item.CodeName}}</div>
                                        <textarea class="subjectInput" id="subject{{item.VoucherDetailsID}}" @focus="SubjectFocus(item,$index,$event);ShowOneVoucher(item)" @blur="SubjectBlur(item,$event)" v-model="item.CodeName"></textarea>

                                        <!--<div ng-show="d.endAmount!=0 &amp;&amp; d.endAmount!='' &amp;&amp; d.endAmount != undefined" class="balance ng-hide" tabindex="-1" aria-hidden="true">
                                            余额: <a href="javaScript:void (0)" tabindex="-1" ng-click="voucherEndAmount(d)" ng-class="{'fontColor':d.endAmount<0}" class="ng-binding"></a>
                                        </div>-->
                                    </div>
                                </th>
                                <th class="listNumberHide"></th>
                                <th>
                                    <ul class="moneyList addList" v-bind:class="{'redFont':item.LeftMoney<0}">
                                        <li v-for="l in item.LeftMoneyArr">{{l.num}}</li>
                                    </ul>
                                    <input type="text" maxlength="11" class="debitText" id="focus0" v-model="item.LeftMoney" @keydown="LeftDown($event);DownData($event)" @keyup="LeftKeyUp($event,item)" @focus="selectValue($event)" @blur="InitLeftValue(item)">
                                </th>
                                <th>
                                    <ul class="moneyList addList" v-bind:class="{'redFont':item.RightMoney<0}">
                                        <li v-for="r in item.RightMoneyArr">{{r.num}}</li>
                                    </ul>
                                    <input type="text" maxlength="11" class="creditText" v-model="item.RightMoney" @keydown="RightDown($event);DownData($event)" @keyup="RightKeyUp($event,item)" @focus="selectValue($event)" @blur="InitRightValue(item)">
                                </th>
                                <th>
                                    <span class="removeDataLine" @click="removeDataLine($index)" tabindex="-1" role="button">-</span>
                                </th>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="tfoot" style="width: 1020px;overflow: hidden;padding: 0 35px;">
                    <table class="table tablefoot" style="background-color:#fff;">
                        <tbody>
                            <tr>
                                <th width="51">票号</th>
                                <th colspan="3" width="382">{{ShowVoucher.TicketNumber}}</th>
                                <th rowspan="2" width="145">合计</th>
                                <th rowspan="2" width="176">
                                    <ul class="moneyList addList" v-bind:class="{'redFont':VoucherDetailInfo.LeftMoney<0}">
                                        <li v-for="l in VoucherDetailInfo.LeftMoneyArr">{{l.num}}</li>
                                    </ul>
                                </th>
                                <th rowspan="2" width="176">
                                    <ul class="moneyList addList" v-bind:class="{'redFont':VoucherDetailInfo.RightMoney<0}">
                                        <li v-for="r in VoucherDetailInfo.RightMoneyArr">{{r.num}}</li>
                                    </ul>
                                </th>
                            </tr>
                            <tr>
                                <th width="51">日期</th>
                                <th colspan="3">{{ShowVoucher.AddTime}}</th>
                            </tr>
                            <tr>
                                <th width="51">项目</th>
                                <th width="128">{{ShowVoucher.ProjectName}}</th>
                                <th width="120">部门</th>
                                <th width="134">{{ShowVoucher.DepartmentName}}</th>
                                <th width="145">制单</th>
                                <th colspan="2">{{VoucherDetailInfo.HandlerName ? VoucherDetailInfo.HandlerName:ShowVoucher.Name}}</th>
                            </tr>
                            <tr>
                                <th width="51">客户</th>
                                <th width="128">{{ShowVoucher.ClientName}}</th>
                                <th width="120">个人</th>
                                <th width="134">{{ShowVoucher.PersonalName}}</th>
                                <th width="145">审核</th>
                                <th colspan="2">{{VoucherDetailInfo.ValiderName}}</th>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="subjectUl">
                    <ul>
                        <li v-for="item in ui.subjectList" @click.stop="SubjectChoice(item)">{{item.Code}}&nbsp;&nbsp;{{item.Name}}</li>
                    </ul>
                </div>
                <div class="foot">
                    <div class="One-man">
                        制单公司:
                        <remote-sel v-bind:setting="CompanySetting" v-bind:value.sync="ShowVoucher.CompanyID"></remote-sel>
                    </div>
                    <button class="layui-btn layui-btn-normal" style="margin-top: 14px;margin-left: 294px;">保存并新增</button>
                    <button class="layui-btn layui-btn-primary" style="margin-top: 14px;margin-left: 18px;" @click="OperaterFinanceVoucher">保存</button>
                    <button class="layui-btn layui-btn-primary" style="margin-top: 14px;margin-left: 18px;">新增</button>
                    <div class="addTemplate">
                        <div class="btn-group dropup dropdown" uib-dropdown="" is-open="status.isopen">
                            <button id="single-button" type="button" class="layui-btn layui-btn-primary" uib-dropdown-toggle="">
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;模板&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-right" uib-dropdown-menu="" role="menu" aria-labelledby="single-button">
                                <li role="menuitem">
                                    <a href="javaScript:void(0)">使用模板</a>
                                </li>
                                <li role="menuitem"><a href="javaScript:void(0)">存为模板</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <link href="//bbsresources.oss-cn-hangzhou.aliyuncs.com/js/modules/layer/css/layui.css" rel="stylesheet">
    <script src="//bbsresources.oss-cn-hangzhou.aliyuncs.com/js/modules/layer/layui.js"></script>
    <script src="//bbsresources.oss-cn-hangzhou.aliyuncs.com/js/modules/vue/vue.min.js"></script>
    <script src="//bbsresources.oss-cn-hangzhou.aliyuncs.com/js/require_config.js"></script>
    <script src="../../Resources/js/moment.min.js"></script>
    <script>
        Vue.filter('formatTime', function (value,format) {
            return moment(value).format(format);
        });
    require_js_file(['table', 'form', 'jquery', 'tableExt', 'jqueryui', 'element', 'customUtil'],
        function (fnr) {
            var $ = layui.$;
            var vm = new Vue({
                el: "#root",
                data: {
                    ShowVoucher:{
                        Type:1,
                        CompanyID:'',
                        TicketNumber:'',
                        Date:'',
                        ProjectID:2,        //项目ID
                        ProjectName:"",    //项目名称
                        DepartmentID:'',        //部门ID
                        DepartmentName:"",    //部门名称
                        ClientID:'',        //客户ID
                        ClientName:"",    //客户名称
                        PersonalID:'',        //个人ID
                        PersonalName:"",    //个人名称
                        Account_ID:'',  //制单人ID
                        Name:'',    //制单人名称
                        AddTime:''
                    },
                    VoucherSetting:{
                        selectedIndex:1,
                         options: [
                             {key:0,value:'收款凭证'},
                             {key:1,value:'付款凭证'},
                             {key:2,value:'转账凭证'},
                             ],
                    },
                    CompanySetting:{
                        search: true,
                        selectedIndex:0,
                        options: [],
                        fields: {root: DEFAULTROOTNODE, key: 'ID', value: 'Name'},
                        remote: {
                            url: '/service/Company/GetCompanyList'
                        },
                        
                    },
                    VoucherDetailInfo:'',
                    ui:{
                        index:'',
                        fixedsubject:'',
                        subjectList: [],//用于前端下拉菜单,
                    },
                },
                ready:function(){
                    $(document).on("click", function (event) {
                        var tarId = event.target.id.substring(6, 0);
                        var subjec = "subjec";
                        if (tarId == subjec) {

                        } else {
                            $(".subjectUl").css("display", "none")
                        }
                    });
                    $(document).on("paste",'input', function (event) {
                        return false
                    });
                    this.GetFinanceCode(0);
                    if(fnr.getQueryString('VoucherID')){
                        //如果存在'voucherid',是查询凭证
                        var VoucherID=fnr.getQueryString('VoucherID');
                        this.GetVoucherDetail(VoucherID)
                    }else{
                        //否者，填制凭证
                        this.initVoucherData()
                        //获取凭证编号
                        this.ShowVoucher.Time=new Date();
                        var Year=moment().format('YYYY');
                        var Month=moment().format('MM');
                        this.GetCurrentNo(Year,Month,this.ShowVoucher.Type);
                    }
                    this.GetSinglePerson();

                },
                methods:{
                    loadInitAmount: function () {
                        return [
                            {num: ""},
                            {num: ""},
                            {num: ""},
                            {num: ""},
                            {num: ""},
                            {num: ""},
                            {num: ""},
                            {num: ""},
                            {num: ""},
                            {num: ""},
                            {num: ""}
                        ];
                    },
                    //初始化voucher数据
                    initVoucherData:function(){
                        this.VoucherDetailInfo={
                                "AddPerson":'',
                                "AddTime":'',
                                "CompanyID":'',
                                "Handler":"",
                                "HandlerName":"",
                                "IsDeleted":"",
                                "LeftMoney":"",
                                "LeftMoneyArr":this.loadInitAmount(),
                                "No":"",
                                "OrderId":'',
                                "ReviewPerson":'',
                                "ReviewStatus":'',
                                "ReviewTime":"",
                                "RightMoney":'',
                                "RightMoneyArr":this.loadInitAmount(),
                                "Time":moment().format('2017-11-29 h:mm:ss'),
                                "Title":'',
                                "Type":'',
                                "Valid":'',
                                "ValidTime":'',
                                "Valider":'',
                                "ValiderName":'',
                                "VoucherDetails":[this.buildInitVoucherRow(),this.buildInitVoucherRow(),this.buildInitVoucherRow(),this.buildInitVoucherRow()],
                                "VoucherID":'',
                            }
                    },
                    //初始化金额显示数组
                    loadInitAmount:function(){
                        return [
                                {num: ""},
                                {num: ""},
                                {num: ""},
                                {num: ""},
                                {num: ""},
                                {num: ""},
                                {num: ""},
                                {num: ""},
                                {num: ""},
                                {num: ""},
                                {num: ""}
                            ];
                    },
                     /**
                     * 添加一个新的row
                     */
                    buildInitVoucherRow:function () {
                        var list = {
                            "AddPerson":"",
                            "AddTime":moment().format('2017-11-29 h:mm:ss'),
                            "ClientName":"",
                            "Client_ID":"",
                            "Code":"",
                            "CodeName":"",
                            "Date":"",
                            "DepartmentName":"",
                            "Department_ID":"",
                            "IsDeleted":"",
                            "LeftMoney":'',
                            "LeftMoneyArr":this.loadInitAmount(),
                            "OrderIndex":"",
                            "PersonName":"",
                            "Person_ID":"",
                            "ProjectName":"",
                            "Project_ID":"",
                            "RightMoney":'',
                            "RightMoneyArr":this.loadInitAmount(),
                            "TicketNumber":"",
                            "Title":"",
                            "VoucherDetailsCID":"",
                            "VoucherDetailsID":"",
                            "VoucherID":"",
                            "LeftMoney":"",
                        }
                        return list;
                    },
                     uiMoneyCalculation: function (m) {
                        var list = [
                            {num: ""},
                            {num: ""},
                            {num: ""},
                            {num: ""},
                            {num: ""},
                            {num: ""},
                            {num: ""},
                            {num: ""},
                            {num: ""},
                            {num: ""},
                            {num: ""}
                        ]
                        var n = m + "";
                        var spot = n.indexOf('.');
                        if (spot > -1) {
                            n = n.split('.');
                            if (n[1].length == 0) {
                                n[1] = '00'
                            }
                            if (n[1].length == 1) {
                                n[1] = n[1] + '0'
                            }
                            n = n[0].concat(n[1])
                            n = Number(n) + ''

                        } else {
                            n = Number(n * 100) + ''
                        }

                        if (n == "NaN" || n == "0") {
                            return list
                        } else {
                            var index = n.indexOf("-")
                            if (index > -1) {
                                n = n.substr(index + 1, n.length)
                            }
                            var index = 11 - n.length;
                            var j = 0;
                            for (var i = index; i < 11; i++) {
                                list[i].num = n[j++]
                            }
                        }
                        return list
                    },
                    //获取凭证编号
                    GetCurrentNo:function(a,b,c){
                        var that=this;
                        $.get('/service/finance/Finance/GetCurrentNo',{Year:a,Month:b,Type:c},function(res){
                            if(res.SuccessResponse){
                                that.VoucherDetailInfo.No=res.Data.No
                            }
                        })
                    },
                    //切换凭证类型
                    TypeChange:function(){
                        var Year=moment().format('YYYY');
                        var Month=moment().format('MM');
                        this.GetCurrentNo(Year,Month,this.ShowVoucher.Type);
                    },
                    formatRows:function(row){
                        this.VoucherDetailInfo.VoucherDetails=[];
                        if(row.length<4){
                            for(var i = 0; i <row.length;i++){
                                
                            }
                        }
                    },
                    //获取单个凭证的详细内容
                    GetVoucherDetail:function(VoucherID){
                        var that=this;
                        $.get('/service/finance/Finance/GetVoucherDetail',{VoucherID:VoucherID},function(res){
                            if(res.SuccessResponse){
                                if(res.Data && res.Data.VoucherDetails.length<4){
                                    var index = 4 - res.Data.VoucherDetails.length;
                                    for (var i = 1; i <= index; i++) {
                                        res.Data.VoucherDetails.push(that.buildInitVoucherRow());
                                    }
                                
                                    $.each(res.Data.VoucherDetails, function(idx, obj) {
                                        obj.LeftMoneyArr=that.uiMoneyCalculation(obj.LeftMoney);
                                        obj.RightMoneyArr=that.uiMoneyCalculation(obj.RightMoney);
                                        res.Data.LeftMoney+=obj.LeftMoney;
                                        res.Data.RightMoney+=obj.RightMoney;
                                        res.Data.LeftMoneyArr=that.uiMoneyCalculation(res.Data.LeftMoney)
                                        res.Data.RightMoneyArr=that.uiMoneyCalculation(res.Data.RightMoney)
                                    });
                                    that.VoucherDetailInfo=res.Data;
                                }else{
                                    that.initVoucherData();
                                }
                            }
                        })
                    },
                    //点击添加一组数据
                    addDataLine:function($event,index){
                        this.VoucherDetailInfo.VoucherDetails.splice(index,0,this.buildInitVoucherRow())
                    },
                    //点击删除当前这组数据
                    removeDataLine:function(index){
                        this.VoucherDetailInfo.VoucherDetails.splice(index,1)
                    },
                    //科目获得焦点
                    SubjectFocus :function(item,index,$event){
                        this.ui.index=index;
                        $event.currentTarget.select();
                        var s = $(".tbodyList")[0].scrollTop;
                        var l = $event.target.parentNode.parentNode.offsetLeft;
                        var t = $event.target.parentNode.parentNode.offsetTop;
                        var h = $event.target.parentNode.parentNode.offsetHeight;
                        var w = $event.target.parentNode.parentNode.offsetWidth;
                        $(".subjectUl").css({
                            display: "block",
                            width: w + "px",
                            left: l + "px",
                            top: t + h - s + "px"
                        });
                    },
                    //科目失去焦点
                    SubjectBlur  :function(item,$event){
                        //$(".subjectUl").scrollTop(0).hide()
                    },
                    //获取财务科目
                    GetFinanceCode: function (val) {
                        var self = this;
                        $.get("/service/finance/Finance/GetFinanceCode", { FinanceCodeType: val,Valid:1 }, function (res) {
                            self.ui.subjectList=res.Data
                        });
                    },
                    //获取当前用户
                    GetSinglePerson:function(){
                        var that=this;
                        $.get('/service/finance/Finance/GetSinglePerson',function(res){
                            if(res.SuccessResponse){
                                that.ShowVoucher.Name=res.Data.Name;
                                that.ShowVoucher.Account_ID=res.Data.Account_ID;
                            }
                        })
                    },
                    //验证每一行的凭证是否合法
                    VerifyVoucherItem:function(item,i){
                        //if (isEmpty(row.summary) && isEmpty(row.subjectTextNo) && isEmpty(row.debitAmount) && isEmpty(row.creditAmount)) {
                        //    return true;
                        //}
                        //if (isEmpty(row.summary)) {
                        //    toaster.clear();
                        //    toaster.warning('系统消息', '第' + (i + 1) + '行未填写摘要');
                        //    return false;
                        //}
                        //if (isEmpty(row.subjectTextNo)) {
                        //    toaster.clear();
                        //    toaster.warning('系统消息', '第' + (i + 1) + '行未填写科目');
                        //    return false;
                        //}
                        //if (isEmpty(row.debitAmount) && isEmpty(row.creditAmount)) {
                        //    if (($scope.data.calculationDebit != 0 && $scope.data.calculationDebit != "") && ($scope.data.calculationCredits != 0 && $scope.data.calculationCredits != "") && ($scope.data.calculationCredits - $scope.data.calculationCredits == 0)) {
                        //        return true
                        //    }
                        //    toaster.clear();
                        //    toaster.warning('系统消息', '第' + (i + 1) + '行未填写金额');
                        //    return false;
                        //}
                        //return true;
                    },
                    SubjectChoice:function(item){
                        var that=this;
                        var Detail=this.VoucherDetailInfo.VoucherDetails[this.ui.index]
                            if(item.ClientCheck || item.DepartmentCheck || item.PersonCheck || item.ProjectCheck){ //客户核算
                                fnr.openDialog({
                                    title: '选择节点',
                                    area: ['500px', '400px'],
                                    content: ['/Html/Voucher/ChoiceNode.html?ClientCheck='+item.ClientCheck+'&DepartmentCheck='+item.DepartmentCheck+'&PersonCheck='+item.PersonCheck+'&ProjectCheck='+item.ProjectCheck],
                                    events: {
                                        refresh: function (data) {
                                            Detail.Client_ID=data.ClientID;
                                            Detail.Date=data.Date;
                                            Detail.Department_ID=data.Department_ID;
                                            Detail.PersonalID=data.PersonalID;
                                            Detail.ProjectID=data.ProjectID;
                                            Detail.TicketNumber=data.TicketNumber;
                                        }
                                    }
                                });
                            }
                            Detail.CodeName=item.Name;
                            Detail.Code=item.Code;
                        $(".subjectUl").css("display", "none")
                    },
                    //转化金额
                    IntegerNumber:function(num){
                        var n=num+'';
                        var s=n.indexOf('.');
                        if(s>-1){
                            n=n.split('.');
                            if(n[1].length==0){
                                n[1]='00'
                            }
                            if(n[1].length==1){
                                n[1]=n[1]+'0'
                            }
                            n=n[0].concat(n[1]);
                            n=parseInt(n)+'';
                        }else{
                            n=parseInt(n*100)+''
                        }
                        return n
                    },
                    //input,textarea聚焦全选
                    selectValue:function($event){
                        $event.target.select();
                    },
                    //借方金额失去焦点赋值
                    InitLeftValue:function(item){
                        this.LeftMoneyAmount();
                        this.RightMoneyAmount();
                        for(var i=0;i<item.LeftMoneyArr.length;i++){
                            item.LeftMoneyArr[i].num='';
                        }
                        var n=Number(this.IntegerNumber(item.LeftMoney))+'';
                        var index=n.indexOf('-');
                        if (index > -1) {
                            n = n.substr(index + 1, n.length)
                        }
                        if(n=="NaN"){
                            item.LeftMoney='';
                            return
                        }else if(n==0){
                            return
                        }else{
                            var index=11-n.length;
                            var j=0;
                            for(var i =index;i<11;i++){
                                 item.LeftMoneyArr[i].num = n[j++];
                            }
                        }
                    },
                     //贷方金额失去焦点赋值
                    InitRightValue:function(item){
                        this.LeftMoneyAmount();
                        this.RightMoneyAmount();
                        for(var i=0;i<item.RightMoneyArr.length;i++){
                            item.RightMoneyArr[i].num='';
                        }
                        var n=Number(this.IntegerNumber(item.RightMoney))+'';
                        var index=n.indexOf('-');
                        if (index > -1) {
                            n = n.substr(index + 1, n.length)
                        }
                        if(n=="NaN"){
                            item.RightMoney='';
                            return
                        }else if(n==0){
                            return
                        }else{
                            var index=11-n.length;
                            var j=0;
                            for(var i =index;i<11;i++){
                                 item.RightMoneyArr[i].num = n[j++];
                            }
                        }
                    },
                    //借方金额键盘事件
                    LeftDown:function($event){
                        if ($event.keyCode == 40) {
                            $($event.target).parent().parent().next().find('.debitText').focus()
                        }
                        if ($event.keyCode == 38) {
                            $($event.target).parent().parent().prev().find('.debitText').focus()
                        }
                        if ($event.keyCode == 13) {
                            $($event.target).parent().next().find('input:eq(0)').focus()
                        }else{
                            this.OnlyNumber($event);
                        }
                    },
                    //贷方金额键盘事件
                    RightDown:function($event){
                        if ($event.keyCode == 40) {
                            $($event.target).parent().parent().next().find('.creditText').focus()
                        }
                        if ($event.keyCode == 38) {
                            $($event.target).parent().parent().prev().find('.creditText').focus()
                        }
                        if ($event.keyCode == 13) {
                            $event.preventDefault()
                            $($event.target).parent().parent().next().find('textarea:eq(0)').focus()
                        }else{
                            this.OnlyNumber($event);
                        }
                    },
                    //获取借方总金额
                    LeftMoneyAmount:function(){
                        var sum=0;
                        this.VoucherDetailInfo.VoucherDetails.forEach(function(item,index,arr){
                            if(item.LeftMoney==''){
                                item.LeftMoney=0;
                            }
                            if(item.LeftMoney==''){
                                item.LeftMoney=0;
                            }
                            sum+=Number(item.LeftMoney);
                            return sum;
                        })
                        this.VoucherDetailInfo.LeftMoney=sum;
                        this.VoucherDetailInfo.LeftMoneyArr=this.uiMoneyCalculation(this.VoucherDetailInfo.LeftMoney)
                    },
                    //获取贷方总金额
                    RightMoneyAmount:function(){
                        var sum=0;
                        this.VoucherDetailInfo.VoucherDetails.forEach(function(item,index,arr){
                            if(item.RightMoney==''){
                                item.RightMoney=0;
                            }
                            if(item.RightMoney==''){
                                item.RightMoney=0;
                            }
                            sum+=Number(item.RightMoney);
                            return sum;
                        })
                        this.VoucherDetailInfo.RightMoney=sum;
                        this.VoucherDetailInfo.RightMoneyArr=this.uiMoneyCalculation(this.VoucherDetailInfo.RightMoney)
                    },
                    //借方金额 keyUp 事件
                    LeftKeyUp:function($event,item){
                        var count=item.LeftMoney;
                        var index=count.indexOf('=');
                        if(index>-1){
                            if(this.VoucherDetailInfo.LeftMoney !=0 || this.VoucherDetailInfo.RightMoney !=0 || item.RightMoney !=0){
                                item.LeftMoney=0;
                                item.RightMoney=0;
                                this.LeftMoneyAmount();
                                this.RightMoneyAmount();
                                item.LeftMoney=this.VoucherDetailInfo.RightMoney - this.VoucherDetailInfo.LeftMoney;
                                item.LeftMoney=item.LeftMoney ==0 ? '' : item.LeftMoney;
                                item.RightMoney = '';
                                for (var i = 0; i < item.RightMoneyArr.length; i++) {
                                    item.RightMoneyArr[i].num = "";
                                };
                            }
                        }
                        item.LeftMoney=this.RemovedInvalid(item.LeftMoney,$event)
                        if(item.LeftMoney>0){
                            if(item.RightMoney || item.RightMoney!=0){
                                item.RightMoney='';
                                item.RightMoneyArr=this.loadInitAmount();
                            }
                        }
                        this.LeftMoneyAmount();
                        this.RightMoneyAmount();
                    },
                    //借方金额 keyUp 事件
                    RightKeyUp:function($event,item){
                        var count=item.RightMoney;
                        var index=count.indexOf('=');
                        if(index>-1){
                            if(this.VoucherDetailInfo.LeftMoney !=0 || this.VoucherDetailInfo.RightMoney !=0 || item.LeftMoney !=0){
                                item.LeftMoney=0;
                                item.RightMoney=0;
                                this.LeftMoneyAmount();
                                this.RightMoneyAmount();
                                item.RightMoney=this.VoucherDetailInfo.LeftMoney - this.VoucherDetailInfo.RightMoney;
                                item.RightMoney=item.RightMoney ==0 ? '' : item.RightMoney;
                                item.LeftMoney = '';
                                for (var i = 0; i < item.LeftMoneyArr.length; i++) {
                                    item.LeftMoneyArr[i].num = "";
                                };
                            }
                        }
                        item.RightMoney=this.RemovedInvalid(item.RightMoney,$event)
                        if(item.RightMoney>0){
                            if(item.LeftMoney || item.LeftMoney!=0){
                                item.LeftMoney='';
                                item.LeftMoneyArr=this.loadInitAmount();
                            }
                        }
                        this.LeftMoneyAmount();
                        this.RightMoneyAmount();
                    },
                    //判断非法字符以及 “ . ” 和 “ - ” 符号
                     RemovedInvalid:function(amount, $event) {
                        if (!this.inputAmount(amount)) {
                            amount = amount + "";
                            var index = amount.indexOf("-")
                            var num = this.countChar(amount, "-")
                            if (index > -1 && num == 1) {
                                if (amount[amount.length - 1] == "-" && num < 2) {
                                    amount = amount[amount.length - 1] + amount.substr(0, amount.length - 1);
                                } else {
                                    amount = amount.substr(0, amount.length - 1);
                                }
                            } else if (amount[amount.length - 1] == "-" && num > 1 && index > -1) {
                                amount = amount.substr(1, amount.length - 2);
                            }
                            else {
                                amount = amount.substr(0, amount.length - 1);
                            }
                        } else {
                            amount = amount + ""
                            var index = amount.indexOf("-")
                            var dian = amount.indexOf(".")
                            if (index > -1 && dian > -1) {
                                if (amount.length > 13) {
                                    amount = amount.substr(0, amount.length - 1)
                                }
                            }
                            if (index > -1 || dian > -1) {
                                if (amount.length > 13) {
                                    amount = amount.substr(0, amount.length - 1)
                                }
                            }
                            if (index == -1 && dian == -1) {
                                if (amount.length > 9) {
                                    amount = amount.substr(0, amount.length - 1)
                                }
                            }
                        }
                        return amount;
                    },
      
                    // 用于查找字符在字符串的个数
                    countChar:function (string, char) {
                        var num = 0;
                        for (var i = 0; i < string.length; i++) {
                            if (string[i] == char) {
                                num++;
                            }
                        }
                        return num;
                    },
                    //匹配金额,小数点前最多九位，小数点后最多两位
                    inputAmount: function (data) {
                        data = $.trim(data);
                        var reg = /(^-{0,1}[0-9](\d+)?(\.\d{0,2})?$)|(^(0){1}$)|(^\d\.\d{0,2}?$)/;
                        return data == '' || reg.test(data);
                    },
                    //显示单条凭证信息
                    ShowOneVoucher:function(item){
                        this.ShowVoucher = $.extend({}, this.ShowVoucher, JSON.parse(JSON.stringify(item)));
                        //this.ShowVoucher=JSON.parse(JSON.stringify(item))
                    },
                    //借方金额和贷方金额只能输入数字
                    DownData:function($event){
                        this.OnlyNumber($event)
                    },
                    //屏蔽除数字外的按键
                    OnlyNumber:function($event){
                        var k = $event.keyCode;
                        if ((k <= 57 && k >= 48) || (k <= 105 && k >= 96) || k == 8 || k == 13 || k == 229 || k == 187
                            || k == 110 || k == 109 || k == 37 || k == 39 || k == 9 || k == 190 || k == 189) {
                            return true
                        } else {
                            $event.preventDefault()
                            return false;
                        }
                    },
                    //填制、修改凭证
                    OperaterFinanceVoucher:function(){
                        var data={
                            No:this.VoucherDetailInfo.No,
                            VoucherID:this.VoucherDetailInfo.VoucherID,
                            Time:this.VoucherDetailInfo.Time,
                            Type:this.ShowVoucher.Type,
                            CompanyID:this.ShowVoucher.CompanyID,
                            Handler:this.VoucherDetailInfo.Handler || 16,
                            VoucherDetails:this.VoucherDetailInfo.VoucherDetails.map(function(item){
                                delete item.LeftMoneyArr;
                                delete item.RightMoneyArr;
                                return item;
                            })
                        };
                        if (data.VoucherID && data.VoucherID!='') {
                            $.ajax({
                                url: "/service/finance/Finance/UpdateFinanceVoucher",
                                method: "post",
                                data: data,
                                success: function (resp) {
                                    if (resp.SuccessResponse) {
                                        
                                    }
                                }
                            });
                        } else {
                            $.ajax({
                                url: "/service/finance/Finance/InsertFinanceVoucher",
                                method: "post",
                                data: data,
                                success: function (resp) {
                                    if (resp.SuccessResponse) {

                                    }
                                }
                            });
                        }
                    }
                },
            });
        });
    </script>
</body>
</html>
